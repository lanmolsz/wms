// <autogenerated>
//   This file was generated by T4 code generator GenerateTreeControllers.tt.
//   Any changes made to this file manually will be lost next time the file is regenerated.
// </autogenerated>

using System;
using System.Collections.Generic;
using Dddml.Wms.Specialization;
using Dddml.Wms.Domain;
using Dddml.Wms.Domain.Metadata;
using Dddml.Wms.HttpServices.Filters;
using System.Linq;
using System.Net;
using System.ComponentModel;
using System.Net.Http;
using System.Net.Http.Formatting;
using System.Web.Http;
using Newtonsoft.Json.Linq;
using Dddml.Support.Criterion;

namespace Dddml.Wms.HttpServices.ApiControllers
{

    [RoutePrefix("api/PermissionTrees")][Authorize]
    public partial class PermissionTreesController : ApiController
    {

        IPermissionTreeApplicationService _permissionTreeApplicationService = ApplicationContext.Current["PermissionTreeApplicationService"] as IPermissionTreeApplicationService;

        [Route(Order = 1)]
        [HttpGet]
        public IEnumerable<PermissionStateDto> Get(string parentId = null, string sort = null, string fields = null, int firstResult = 0, int maxResults = int.MaxValue, string filter = null)
        {
          try {
            var parentIdObj = parentId == null ? null : parentId;
            IEnumerable<IPermissionState> states = null; 
            if (!String.IsNullOrWhiteSpace(filter))
            {
                if (parentIdObj == null)
                {
                    if (IsOnlyIdReturned(fields))
                    {
                        var ids = _permissionTreeApplicationService.GetRootIds(CriterionDto.ToSubclass(JObject.Parse(filter).ToObject<CriterionDto>(),new ApiControllerTypeConverter(), new PropertyTypeResolver())
                            , PermissionsControllerUtils.GetQueryOrders(sort, QueryOrderSeparator), firstResult, maxResults);
                        states = PermissionsControllerUtils.ToPermissionStateDtoCollection(ids);
                    }
                    else
                    {
                        states = _permissionTreeApplicationService.GetRoots(CriterionDto.ToSubclass(JObject.Parse(filter).ToObject<CriterionDto>(),new ApiControllerTypeConverter(), new PropertyTypeResolver())
                            , PermissionsControllerUtils.GetQueryOrders(sort, QueryOrderSeparator), firstResult, maxResults);
                    }
                }
                else
                {
                    if (IsOnlyIdReturned(fields))
                    {
                        var ids = _permissionTreeApplicationService.GetChildIds(parentIdObj, CriterionDto.ToSubclass(JObject.Parse(filter).ToObject<CriterionDto>(),new ApiControllerTypeConverter(), new PropertyTypeResolver())
                            , PermissionsControllerUtils.GetQueryOrders(sort, QueryOrderSeparator), firstResult, maxResults);
                        states = PermissionsControllerUtils.ToPermissionStateDtoCollection(ids);
                    }
                    else
                    {
                        states = _permissionTreeApplicationService.GetChildren(parentIdObj, CriterionDto.ToSubclass(JObject.Parse(filter).ToObject<CriterionDto>(),new ApiControllerTypeConverter(), new PropertyTypeResolver())
                            , PermissionsControllerUtils.GetQueryOrders(sort, QueryOrderSeparator), firstResult, maxResults);
                    }
                }
            }
            else
            {
                if (parentIdObj == null)
                {
                    if (IsOnlyIdReturned(fields))
                    {
                        var ids = _permissionTreeApplicationService.GetRootIds(PermissionsControllerUtils.GetQueryFilterDictionary(this.Request.GetQueryNameValuePairs())
                            , PermissionsControllerUtils.GetQueryOrders(sort, QueryOrderSeparator), firstResult, maxResults);
                        states = PermissionsControllerUtils.ToPermissionStateDtoCollection(ids);
                    }
                    else
                    {
                        states = _permissionTreeApplicationService.GetRoots(PermissionsControllerUtils.GetQueryFilterDictionary(this.Request.GetQueryNameValuePairs())
                            , PermissionsControllerUtils.GetQueryOrders(sort, QueryOrderSeparator), firstResult, maxResults);
                    }
                }
                else
                {
                    if (IsOnlyIdReturned(fields))
                    {
                        var ids = _permissionTreeApplicationService.GetChildIds(parentIdObj, PermissionsControllerUtils.GetQueryFilterDictionary(this.Request.GetQueryNameValuePairs())
                            , PermissionsControllerUtils.GetQueryOrders(sort, QueryOrderSeparator), firstResult, maxResults);
                        states = PermissionsControllerUtils.ToPermissionStateDtoCollection(ids);
                    }
                    else
                    {
                        states = _permissionTreeApplicationService.GetChildren(parentIdObj, PermissionsControllerUtils.GetQueryFilterDictionary(this.Request.GetQueryNameValuePairs())
                            , PermissionsControllerUtils.GetQueryOrders(sort, QueryOrderSeparator), firstResult, maxResults);
                    }
                }
            }
            var stateDtos = new List<PermissionStateDto>();
            foreach (var s in states)
            {
                var dto = s is PermissionStateDto ? (PermissionStateDto)s : new PermissionStateDto((PermissionState)s);
                if (String.IsNullOrWhiteSpace(fields))
                {
                    dto.AllFieldsReturned = true;
                }
                else
                {
                    dto.ReturnedFieldsString = fields;
                }
                stateDtos.Add(dto);
            }
            return stateDtos;
          } catch (Exception ex) { var response = PermissionsControllerUtils.GetErrorHttpResponseMessage(ex); throw new HttpResponseException(response); }
        }

        [Route("_metadata/filteringFields")]
        [HttpGet]
        public IEnumerable<PropertyMetadata> GetMetadataFilteringFields()
        {
          try {
            var filtering = new List<PropertyMetadata>();
            foreach (var p in PermissionMetadata.Instance.Properties)
            {
                if (p.IsFilteringProperty)
                {
                    filtering.Add(p);
                }
            }
            return filtering;
          } catch (Exception ex) { var response = PermissionsControllerUtils.GetErrorHttpResponseMessage(ex); throw new HttpResponseException(response); }
        }

		// /////////////////////////////////////////////////

        protected bool IsOnlyIdReturned(string fields)
        {
            if (String.Equals(fields, "PermissionId", StringComparison.InvariantCultureIgnoreCase))
            {
                return true;
            }
            return false;
        }


        protected virtual string QueryOrderSeparator
        {
            get { return ","; }
        }

        // ////////////////////////////////

        private class ApiControllerTypeConverter : Dddml.Support.Criterion.ITypeConverter
        {
            public T ConvertFromString<T>(string text)
            {
                return (T)ApplicationContext.Current.TypeConverter.ConvertFromString(typeof(T), text);
            }

            public object ConvertFromString(Type type, string text)
            {
                return ApplicationContext.Current.TypeConverter.ConvertFromString(type, text);
            }

            public string ConvertToString<T>(T value)
            {
                return ApplicationContext.Current.TypeConverter.ConvertToString(typeof(T), value);
            }

            public string ConvertToString(object value)
            {
                return ApplicationContext.Current.TypeConverter.ConvertToString(value.GetType(), value);
            }

            public string[] ConvertToStringArray(object[] values)
            {
                throw new NotSupportedException();
            }
        }

        private class PropertyTypeResolver : IPropertyTypeResolver
        {

            public Type ResolveTypeByPropertyName(string propertyName)
            {
                return PermissionsControllerUtils.GetFilterPropertyType(propertyName);
            }
        }

    }

}

